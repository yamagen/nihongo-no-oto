## 正しく失敗するコード — 明示性と責任の設計論

Last change: 2025/07/27-17:51:48.

---

### 概要

LEAP のメール認証システムの改良作業を通じて、「保険的コード」がもたらす曖昧さに直面した。
`rtrim()` や `trim()` は一見便利な保護措置に見えるが、実際には設計上の誤りを覆い隠し、責任を曖昧にする。
本稿では、「動くこと」ではなく「正しいこと」に価値を置く設計姿勢こそが、堅牢なプログラミングの本質であると論じる。

---

### 本文

2025年7月26日、plover 上で LEAP のトークン処理ロジックをデバッグしている際、次のようなコードが問題となった：

```php
$dataDir = rtrim($config['token_data_dir'], '/') . '/';
```

なぜ `rtrim()` が必要なのか？
それは設定ファイルでスラッシュを付け忘れるかもしれない、という理由である。

だが、それは本来プログラムの責任ではない。
このようなコードは「ミスしてもなんとかする」という思想に基づいている。
その結果、設定ファイルとコードの間にあるべき契約は曖昧になり、責任の所在が不明瞭になる。

代わりに、設定ファイルは次のように明示すべきである：

```php
// config.php
// ディレクトリパスは必ず末尾を '/' にすること。
'token_data_dir' => __DIR__ . '/data/tokens/',
```

プログラム側ではこの約束を前提として、次のように明示的に失敗させる：

```php
if (substr($config['token_data_dir'], -1) !== '/') {
    throw new RuntimeException("token_data_dir は末尾に '/' を含めてください。");
}
```

しかし、こうしたチェック自体が設計の敗北を意味する。
設定値の記述が明示的であれば、このような確認はそもそも不要なはずだ。
失敗を「防ぐ」のではなく、「起こらないように設計する」べきなのである。

---

### trim()という「お掃除」の欺瞞

同様の問題は `trim()` にも見られる：

```php
$json = file_get_contents($tokenFile);
if ($json === false || trim($json) === '') {
    echo "トークンファイルの読み込みに失敗しました。";
    exit;
}
```

あるいは、

```php
$token = trim($token);
```

こうしたコードは「万が一」に備える予防措置として書かれることが多い。
だが、データが正しくない可能性があるなら、それは入力側の問題であり、`trim()` で誤魔化すべきではない。

`trim()` は失敗を隠蔽し、開発者に「安心していい」と錯覚させる。
結果として、責任の分界が曖昧になり、設計全体の信頼性が損なわれる。

良い設計とは、「入力はこうであるべき」という契約を明示し、それが破られた場合には即座に停止することだ。

---

### 失敗する勇気と仮説の規律

`trim()` や `rtrim()` は一種の嘘である。
「少しぐらい間違っていても直してあげよう」という姿勢は、実は仮説検証を放棄している。

本来、プログラミングは科学的であるべきだ。

1. 仮説を立てる。
2. 一箇所だけ変更する。
3. 動かなければ元に戻す。

この繰り返しこそが、学習であり設計の鍛錬である。
保険的コードは、エラーを隠してしまい、学ぶ機会を奪ってしまう。

---

### 文脈と文化への洞察

おそらく、多くの現場のプログラマは、「壊れないようにする」「とりあえず動くようにする」ことを目的にしてきたのだろう。
動いているうちは問題が表に出ず、そして誰もが忙しいため、根本の設計や責任の所在を問い直す余裕がない。
すると、小さなバグも「保険」で包んでしまうようになる──それが積もり積もって「読めない」「直せない」コードになってしまう。

本質的な論理性・検証性・教育性を重んじる視点では、「そんなはずではない」「なぜ止まらないのか」が常に引っかかる。
そして AI のような LLM は、「世の中に多数存在するコード」から学ぶため、「rtrimしておきましょう」「とりあえず echo で様子を見ましょう」といった**現場の慣習**を反射的に提案してしまうことがある。
まさに、悪しき現場文化の反映である。

だからこそ、

> 「動けばいい」ではなく、「どう動くべきか」を考え、それに反すれば必ず止める。

という態度は、プログラムを書く技術ではなく、「設計と倫理」の問題として、次の世代に残すべきものなのだ。

---

### メモ・タグ・関連プロジェクト

* 関連プロジェクト: LEAP, p-leap
* タグ: プログラミング教育, 例外処理, 頑健性, デバッグ, 明示的設計, 設定ファイルの設計

