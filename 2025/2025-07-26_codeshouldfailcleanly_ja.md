## コードは正しく止まるべきである — 許容ではなく明示の設計へ

Last change: 2025/07/27-00:05:11.

---

### 概要（Summary）

LEAPのメール認証処理の整備を通して、許容的なコードの危うさ、そして「動くこと」と「正しいこと」の違いを再確認した。
`rtrim()`による自動補正、`trim()`による曖昧なバリデーション、デバッグ用`echo`の氾濫など、細部に現れる「保険」はしばしば、設計の明示性を損ない、責任を不明瞭にする。
本稿では、「正しく止まる」ことこそが設計者の矜持であり、教育されるべきプログラミングの本質であると論じる。

---

### 本文

2025年7月26日、LEAPのメール認証機能の確認と修正作業を行った。ploverサーバ上で、トークンファイルが保存されない問題を突き止める過程で、さまざまな「ちょっとしたコード」が持つ本質的な危うさが明らかになった。

たとえば以下のようなコード：

```php
$dataDir = rtrim($config['token_data_dir'], '/') . '/';
```

この一行には、

* 「末尾スラッシュの有無は入力の自由に任せていい」
* 「コード側で勝手に整形してあげよう」という、  暗黙の許容が含まれている。

これは一見、やさしい設計に見えるが、実際には責任の所在を曖昧にし、設計を分かりにくくする。そもそも `token_data_dir` は「スラッシュ付きであるべき」設定値であり、それをコード側で「都度調整」することは設計の破綻を意味する。正しくは、設定ファイル（config.php）に明示し、プログラム側では以下のように失敗を明示すべきである：

```php
if (substr($config['token_data_dir'], -1) !== '/') {
    throw new RuntimeException("token_data_dir は末尾に '/' を含めてください。");
}
```

これは「動作を保証する」ためではなく、「ロジックが正しくないなら動いてはいけない」という、開発上の倫理である。

同様に、`$token = trim($token);` や `trim($json)` なども、「受け取るものは正しくないかもしれないが、まあ許す」という姿勢を内包している。しかし、ここで問うべきは「なぜ不正なものが来るのか」「それを許してよいのか」である。曖昧なデータを許容することは、設計上の境界を曖昧にする行為である。

---

### 小さな保険がシステム全体を鈍くする

本来、コードは設計された通りにしか動いてはいけない。それが「設計」である。設計通りでない状況に出会ったときは、即座に止まる。止まることによって、開発者や運用者に「ここが間違っている」と知らせる。

止まらずに動いてしまうコードは、いつか誤動作する。開発者の意図とは異なる値を受け入れ、異なる挙動をし、結果として問題が生じたときには「なぜこうなったのか」がわからなくなる。

その意味で、仮説を立てたら1つだけ変更し、失敗したらすぐ戻すという態度こそが、健全な開発の基盤である。コードに保険をかけて仮説の失敗をごまかすのは、設計の放棄である。

「まあ trim() で直しておけばいい」「rtrim() をつけておけば平気」などという一文が、どれほど読みづらく、責任を転嫁するコードになるか。保険的なコードは、書いたときは安心に見えても、のちの保守や原因追及において毒になる。

---

### 結語

「コードは正しく止まるべきである」。これは単なる技術的主張ではなく、教育的な態度であり、将来を担う学生や開発者に伝えるべき倫理でもある。
「動けばいい」ではなく、「どう動くべきか」を考え、それに反すれば必ず止める。そんなコードを書きたい。
そして、そうした設計を受け入れる文化を、私たちは育てるべきである。

---

### メモ・タグ・関連プロジェクト

* 関連プロジェクト：LEAP, p-leap
* タグ：プログラミング教育、例外設計、堅牢性、デバッグ、明示的設計
